const A=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"http://127.0.0.1:8000":"https://studyo.onrender.com",c=`${A}/api`;class p extends Error{constructor(e,n,o){super(e),this.name="ApiError",this.status=n,this.payload=o}}function u(){return localStorage.getItem("authToken")}function $(t){localStorage.setItem("authToken",t)}function g(){localStorage.removeItem("authToken")}function l(t="application/json"){const e={"Content-Type":t},n=u();return n&&(e.Authorization=`Token ${n}`),e}function U(){try{const t=window.__studyoCaptureFocusState;if(typeof t=="function"){const e=t();e&&localStorage.setItem("studyo_focus_snapshot",JSON.stringify(e))}localStorage.setItem("studyo_auth_return_path",window.location.href)}catch{}try{window.dispatchEvent(new CustomEvent("auth:expired"))}catch{}}async function i(t){const e=async()=>{const n=`HTTP Error ${t.status}`,o=t.clone();try{const r=await o.json(),a=r?.detail||r?.message;return{message:typeof a=="string"?a:JSON.stringify(r),payload:r}}catch{try{return{message:await t.text()||n}}catch{return{message:n}}}};if(t.status===401||t.status===403){U(),g();const{message:n,payload:o}=await e();throw new p(n||"Session expired. Please login again.",t.status,o)}if(t.status===204)return null;if(!t.ok){const{message:n,payload:o}=await e();throw new p(n,t.status,o)}return t.json()}async function v(t){const e=await fetch(`${c}${t}`,{method:"GET",headers:l(),credentials:"include"});return i(e)}async function _(t,e,n=!1){if(n&&!u())throw new Error("User not authenticated");const o=await fetch(`${c}${t}`,{method:"POST",headers:l(),body:JSON.stringify(e),credentials:"include"});return i(o)}async function R(t,e){if(!u())throw new Error("User not authenticated");const n=await fetch(`${c}${t}`,{method:"PUT",headers:l(),body:JSON.stringify(e),credentials:"include"});return i(n)}async function C(t,e){if(!u())throw new Error("User not authenticated");const n=await fetch(`${c}${t}`,{method:"PATCH",headers:l(),body:JSON.stringify(e),credentials:"include"});return i(n)}async function L(t){if(!u())throw new Error("User not authenticated");const e=await fetch(`${c}${t}`,{method:"DELETE",headers:l(),credentials:"include"});return i(e)}async function V(t,e){const n=await fetch(`${c}/login/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e}),credentials:"include"});try{const o=await i(n);return o.token&&$(o.token),o}catch(o){let r="Login failed";try{const a=JSON.parse(o.message);r=a.detail||a.non_field_errors?.[0]||r}catch{r=o.message}throw new Error(r)}}async function K(t,e,n,o,r,a){const s=await fetch(`${c}/signup/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:e,password:n,first_name:o,last_name:r,country:a}),credentials:"include"});return i(s)}async function X(){if(u())try{await fetch(`${c}/logout/`,{method:"POST",headers:l(),credentials:"include"})}catch(e){console.error("Logout error:",e)}finally{g()}}async function Q(t){const e=await fetch(`${c}/auth/password-reset/request/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t}),credentials:"include"});return i(e)}async function Z(t,e){const n=new URLSearchParams({email:t,token:e}),o=await fetch(`${c}/auth/password-reset/validate/?${n.toString()}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return i(o)}async function tt(t,e,n){const o=await fetch(`${c}/auth/password-reset/confirm/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,token:e,password:n}),credentials:"include"});return i(o)}async function I(){return v("/user/me/")}async function et(t){return C("/user/me/",t)}async function nt(t){if(!u())throw new Error("User not authenticated");const e=u(),n=new FormData;n.append("avatar",t);const o=["/user/me/avatar/","/user/me/photo/"];for(const r of o)try{const a=await fetch(`${c}${r}`,{method:"POST",headers:{Authorization:`Token ${e}`},body:n,credentials:"include"});if(!a.ok){if(a.status===404)continue;return i(a)}return i(a)}catch{continue}try{const r=await fetch(`${c}/user/me/`,{method:"PATCH",headers:{Authorization:`Token ${e}`},body:n,credentials:"include"});if(r.ok)return i(r);if(r.status===405)try{const a=await fetch(`${c}/user/me/`,{method:"PUT",headers:{Authorization:`Token ${e}`},body:n,credentials:"include"});if(a.ok)return i(a)}catch{}}catch{}try{const a=await(h=>new Promise((P,x)=>{const f=new FileReader;f.onload=()=>P(String(f.result)),f.onerror=x,f.readAsDataURL(h)}))(t),s=await fetch(`${c}/user/me/`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Token ${e}`},body:JSON.stringify({avatar:a}),credentials:"include"});if(s.ok)return i(s)}catch{}throw new Error("Avatar upload endpoint not found on server")}async function ot(){return v("/events/")}async function rt(t){return _("/events/",t,!0)}async function at(t,e){return R(`/events/${t}/`,e)}async function st(t){await L(`/events/${t}/`)}const O=["/","/index","/login","/register","/forgot-password","/reset-password"],w={status:"checking",isAuthenticated:!1,token:null,user:null,authResolved:!1},z=8e3,E=1,j=1200;function N(){const t=localStorage.getItem("appLanguage");return t==="en"?"Checking session...":t==="pt"?"Verificando sess�o...":t==="zh"?"Checking session...":"Verificando sesi�n..."}function B(t,e,n){return new Promise((o,r)=>{const a=window.setTimeout(()=>r(new Error(n)),e);t.then(s=>{window.clearTimeout(a),o(s)}).catch(s=>{window.clearTimeout(a),r(s)})})}function J(t){return new Promise(e=>window.setTimeout(e,t))}function H(){const t=[document.documentElement,document.body].filter(n=>!!n),e=["zoom","transform","transform-origin"];t.forEach(n=>{e.forEach(o=>n.style.removeProperty(o)),n.style.setProperty("zoom","1"),n.style.setProperty("transform","none"),n.style.setProperty("transform-origin","0 0")})}function M(t){Object.assign(w,t),window.__studyoAuthState={...w};try{window.dispatchEvent(new CustomEvent("auth:state",{detail:window.__studyoAuthState}))}catch{}}function q(){if(document.getElementById("auth-loading"))return;const t=document.createElement("div");t.id="auth-loading",t.innerHTML=`
        <div class="auth-loading-spinner"></div>
        <div class="auth-loading-text">${N()}</div>
    `,document.body.appendChild(t),document.documentElement.classList.add("auth-pending")}function G(){document.documentElement.classList.remove("auth-pending"),document.getElementById("auth-loading")?.remove()}function b(){document.getElementById("auth-error")?.remove()}function D(t,e){let n=document.getElementById("auth-error");n||(n=document.createElement("div"),n.id="auth-error",n.style.position="fixed",n.style.left="50%",n.style.bottom="24px",n.style.transform="translateX(-50%)",n.style.zIndex="10000",n.style.maxWidth="640px",n.style.width="calc(100% - 32px)",n.style.background="rgba(13,16,22,0.98)",n.style.border="1px solid rgba(168,85,247,0.45)",n.style.borderRadius="14px",n.style.padding="14px",n.style.boxShadow="0 8px 26px rgba(0,0,0,0.35)",n.style.color="#e5e7eb",n.innerHTML=`
            <div style="font-size:14px;font-weight:600;margin-bottom:8px">No se pudo validar tu sesión.</div>
            <div id="auth-error-detail" style="font-size:13px;opacity:.9;margin-bottom:12px"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
                <button id="auth-retry-btn" type="button" style="background:#1f2937;color:#fff;border:1px solid #374151;border-radius:8px;padding:7px 12px;cursor:pointer">Reintentar</button>
                <button id="auth-login-btn" type="button" style="background:linear-gradient(90deg,#7c3aed,#d946ef);color:#fff;border:none;border-radius:8px;padding:7px 12px;cursor:pointer">Ir al login</button>
            </div>
        `,document.body.appendChild(n),n.querySelector("#auth-retry-btn")?.addEventListener("click",()=>{Y({loginPath:t})}),n.querySelector("#auth-login-btn")?.addEventListener("click",()=>{const r=window.location.pathname;m(t,r)}));const o=n.querySelector("#auth-error-detail");o&&(o.textContent=e||"Revisa tu conexión o intenta nuevamente.")}function y(t){let e=t||"/";return e.startsWith("/")||(e=`/${e}`),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e.endsWith(".html")&&(e=e.slice(0,-5)),e||"/"}function k(t){return O.includes(y(t))}function T(){try{return u()}catch{return null}}function W(t){if(t instanceof p)return t.status;const e=t?.status??t?.response?.status;return typeof e=="number"?e:void 0}function S(t){const e=t?.message;return typeof e=="string"&&e.trim().length?e:"Error de conexión"}function F(t,e){if(t===401||t===403)return!1;const n=S(e).toLowerCase();return n.includes("auth check timeout")||n.includes("network")||n.includes("failed to fetch")?!0:t===void 0||t>=500}function d(t,e){document.documentElement.classList.remove("auth-pending"),document.getElementById("auth-loading")?.remove(),t!=="error"&&b(),M({status:t,authResolved:t!=="checking",...e}),t==="checking"?q():G()}function m(t,e){const n=y(e),o=y(t);if(k(e)||n===o)return;const r=encodeURIComponent(window.location.href);window.location.href=`${o}?next=${r}`}async function Y(t){document.documentElement.classList.remove("auth-pending"),document.getElementById("auth-loading")?.remove(),b(),H();const e=t?.loginPath??"/login",n=window.location.pathname;if(k(n)){const s=T();d("public",{isAuthenticated:!!s,token:s,user:null});return}d("checking");const r=T();if(!r){d("unauthenticated",{isAuthenticated:!1,token:null,user:null}),m(e,n);return}let a=0;for(;a<=E;)try{const s=await B(I(),z,"Auth check timeout");d("authenticated",{isAuthenticated:!0,token:r,user:s});return}catch(s){const h=W(s);if(h===401||h===403){g(),d("unauthenticated",{isAuthenticated:!1,token:null,user:null}),m(e,n);return}if(a<E&&F(h,s)){a+=1,await J(j*a);continue}d("error",{isAuthenticated:!1,token:r,user:null}),D(e,S(s));return}}window.addEventListener("auth:expired",()=>{const t=window.location.pathname;d("unauthenticated",{isAuthenticated:!1,token:null,user:null}),m("/login",t)});export{c as B,X as a,v as b,R as c,_ as d,ot as e,L as f,I as g,u as h,Y as i,C as j,at as k,V as l,rt as m,st as n,nt as o,Q as p,tt as q,K as r,et as u,Z as v};
