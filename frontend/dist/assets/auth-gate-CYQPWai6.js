const P=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"http://127.0.0.1:8000":"https://studyo-backend.onrender.com",c=`${P}/api`;class p extends Error{constructor(n,e,o){super(n),this.name="ApiError",this.status=e,this.payload=o}}function u(){return localStorage.getItem("authToken")}function A(t){localStorage.setItem("authToken",t)}function y(){localStorage.removeItem("authToken")}function l(t="application/json"){const n={"Content-Type":t},e=u();return e&&(n.Authorization=`Token ${e}`),n}function $(){try{const t=window.__studyoCaptureFocusState;if(typeof t=="function"){const n=t();n&&localStorage.setItem("studyo_focus_snapshot",JSON.stringify(n))}localStorage.setItem("studyo_auth_return_path",window.location.href)}catch{}try{window.dispatchEvent(new CustomEvent("auth:expired"))}catch{}}async function i(t){const n=async()=>{const e=`HTTP Error ${t.status}`,o=t.clone();try{const r=await o.json(),a=r?.detail||r?.message;return{message:typeof a=="string"?a:JSON.stringify(r),payload:r}}catch{try{return{message:await t.text()||e}}catch{return{message:e}}}};if(t.status===401||t.status===403){$(),y();const{message:e,payload:o}=await n();throw new p(e||"Session expired. Please login again.",t.status,o)}if(t.status===204)return null;if(!t.ok){const{message:e,payload:o}=await n();throw new p(e,t.status,o)}return t.json()}async function T(t){const n=await fetch(`${c}${t}`,{method:"GET",headers:l(),credentials:"include"});return i(n)}async function U(t,n,e=!1){if(e&&!u())throw new Error("User not authenticated");const o=await fetch(`${c}${t}`,{method:"POST",headers:l(),body:JSON.stringify(n),credentials:"include"});return i(o)}async function _(t,n){if(!u())throw new Error("User not authenticated");const e=await fetch(`${c}${t}`,{method:"PUT",headers:l(),body:JSON.stringify(n),credentials:"include"});return i(e)}async function R(t,n){if(!u())throw new Error("User not authenticated");const e=await fetch(`${c}${t}`,{method:"PATCH",headers:l(),body:JSON.stringify(n),credentials:"include"});return i(e)}async function C(t){if(!u())throw new Error("User not authenticated");const n=await fetch(`${c}${t}`,{method:"DELETE",headers:l(),credentials:"include"});return i(n)}async function V(t,n){const e=await fetch(`${c}/login/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:n}),credentials:"include"});try{const o=await i(e);return o.token&&A(o.token),o}catch(o){let r="Login failed";try{const a=JSON.parse(o.message);r=a.detail||a.non_field_errors?.[0]||r}catch{r=o.message}throw new Error(r)}}async function W(t,n,e,o,r,a){const s=await fetch(`${c}/signup/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:n,password:e,first_name:o,last_name:r,country:a}),credentials:"include"});return i(s)}async function K(){if(u())try{await fetch(`${c}/logout/`,{method:"POST",headers:l(),credentials:"include"})}catch(n){console.error("Logout error:",n)}finally{y()}}async function X(t){const n=await fetch(`${c}/auth/password-reset/request/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t}),credentials:"include"});return i(n)}async function Q(t,n){const e=new URLSearchParams({email:t,token:n}),o=await fetch(`${c}/auth/password-reset/validate/?${e.toString()}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return i(o)}async function Z(t,n,e){const o=await fetch(`${c}/auth/password-reset/confirm/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,token:n,password:e}),credentials:"include"});return i(o)}async function L(){return T("/user/me/")}async function tt(t){return R("/user/me/",t)}async function et(t){if(!u())throw new Error("User not authenticated");const n=u(),e=new FormData;e.append("avatar",t);const o=["/user/me/avatar/","/user/me/photo/"];for(const r of o)try{const a=await fetch(`${c}${r}`,{method:"POST",headers:{Authorization:`Token ${n}`},body:e,credentials:"include"});if(!a.ok){if(a.status===404)continue;return i(a)}return i(a)}catch{continue}try{const r=await fetch(`${c}/user/me/`,{method:"PATCH",headers:{Authorization:`Token ${n}`},body:e,credentials:"include"});if(r.ok)return i(r);if(r.status===405)try{const a=await fetch(`${c}/user/me/`,{method:"PUT",headers:{Authorization:`Token ${n}`},body:e,credentials:"include"});if(a.ok)return i(a)}catch{}}catch{}try{const a=await(h=>new Promise((S,x)=>{const f=new FileReader;f.onload=()=>S(String(f.result)),f.onerror=x,f.readAsDataURL(h)}))(t),s=await fetch(`${c}/user/me/`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Token ${n}`},body:JSON.stringify({avatar:a}),credentials:"include"});if(s.ok)return i(s)}catch{}throw new Error("Avatar upload endpoint not found on server")}async function nt(){return T("/events/")}async function ot(t){return U("/events/",t,!0)}async function rt(t,n){return _(`/events/${t}/`,n)}async function at(t){await C(`/events/${t}/`)}const I=["/","/index.html","/login.html","/register.html","/forgot-password.html","/reset-password.html"],g={status:"checking",isAuthenticated:!1,token:null,user:null,authResolved:!1},O=8e3,w=1,j=1200;function N(){const t=localStorage.getItem("appLanguage");return t==="en"?"Checking session...":t==="pt"?"Verificando sessão...":t==="zh"?"Checking session...":"Verificando sesión..."}function B(t,n,e){return new Promise((o,r)=>{const a=window.setTimeout(()=>r(new Error(e)),n);t.then(s=>{window.clearTimeout(a),o(s)}).catch(s=>{window.clearTimeout(a),r(s)})})}function z(t){return new Promise(n=>window.setTimeout(n,t))}function J(){const t=[document.documentElement,document.body].filter(e=>!!e),n=["zoom","transform","transform-origin"];t.forEach(e=>{n.forEach(o=>e.style.removeProperty(o)),e.style.setProperty("zoom","1"),e.style.setProperty("transform","none"),e.style.setProperty("transform-origin","0 0")})}function H(t){Object.assign(g,t),window.__studyoAuthState={...g};try{window.dispatchEvent(new CustomEvent("auth:state",{detail:window.__studyoAuthState}))}catch{}}function M(){if(document.getElementById("auth-loading"))return;const t=document.createElement("div");t.id="auth-loading",t.innerHTML=`
        <div class="auth-loading-spinner"></div>
        <div class="auth-loading-text">${N()}</div>
    `,document.body.appendChild(t),document.documentElement.classList.add("auth-pending")}function q(){document.documentElement.classList.remove("auth-pending"),document.getElementById("auth-loading")?.remove()}function v(){document.getElementById("auth-error")?.remove()}function G(t,n){let e=document.getElementById("auth-error");e||(e=document.createElement("div"),e.id="auth-error",e.style.position="fixed",e.style.left="50%",e.style.bottom="24px",e.style.transform="translateX(-50%)",e.style.zIndex="10000",e.style.maxWidth="640px",e.style.width="calc(100% - 32px)",e.style.background="rgba(13,16,22,0.98)",e.style.border="1px solid rgba(168,85,247,0.45)",e.style.borderRadius="14px",e.style.padding="14px",e.style.boxShadow="0 8px 26px rgba(0,0,0,0.35)",e.style.color="#e5e7eb",e.innerHTML=`
            <div style="font-size:14px;font-weight:600;margin-bottom:8px">No se pudo validar tu sesiÃ³n.</div>
            <div id="auth-error-detail" style="font-size:13px;opacity:.9;margin-bottom:12px"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
                <button id="auth-retry-btn" type="button" style="background:#1f2937;color:#fff;border:1px solid #374151;border-radius:8px;padding:7px 12px;cursor:pointer">Reintentar</button>
                <button id="auth-login-btn" type="button" style="background:linear-gradient(90deg,#7c3aed,#d946ef);color:#fff;border:none;border-radius:8px;padding:7px 12px;cursor:pointer">Ir al login</button>
            </div>
        `,document.body.appendChild(e),e.querySelector("#auth-retry-btn")?.addEventListener("click",()=>{Y({loginPath:t})}),e.querySelector("#auth-login-btn")?.addEventListener("click",()=>{const r=window.location.pathname;m(t,r)}));const o=e.querySelector("#auth-error-detail");o&&(o.textContent=n||"Revisa tu conexiÃ³n o intenta nuevamente.")}function b(t){return I.includes(t)}function E(){try{return u()}catch{return null}}function D(t){if(t instanceof p)return t.status;const n=t?.status??t?.response?.status;return typeof n=="number"?n:void 0}function k(t){const n=t?.message;return typeof n=="string"&&n.trim().length?n:"Error de conexiÃ³n"}function F(t,n){if(t===401||t===403)return!1;const e=k(n).toLowerCase();return e.includes("auth check timeout")||e.includes("network")||e.includes("failed to fetch")?!0:t===void 0||t>=500}function d(t,n){document.documentElement.classList.remove("auth-pending"),document.getElementById("auth-loading")?.remove(),t!=="error"&&v(),H({status:t,authResolved:t!=="checking",...n}),t==="checking"?M():q()}function m(t,n){if(b(n)||n.endsWith(t))return;const e=encodeURIComponent(window.location.href);window.location.href=`${t}?next=${e}`}async function Y(t){document.documentElement.classList.remove("auth-pending"),document.getElementById("auth-loading")?.remove(),v(),J();const n=t?.loginPath??"login.html",e=window.location.pathname;if(b(e)){const s=E();d("public",{isAuthenticated:!!s,token:s,user:null});return}d("checking");const r=E();if(!r){d("unauthenticated",{isAuthenticated:!1,token:null,user:null}),m(n,e);return}let a=0;for(;a<=w;)try{const s=await B(L(),O,"Auth check timeout");d("authenticated",{isAuthenticated:!0,token:r,user:s});return}catch(s){const h=D(s);if(h===401||h===403){y(),d("unauthenticated",{isAuthenticated:!1,token:null,user:null}),m(n,e);return}if(a<w&&F(h,s)){a+=1,await z(j*a);continue}d("error",{isAuthenticated:!1,token:r,user:null}),G(n,k(s));return}}window.addEventListener("auth:expired",()=>{const t=window.location.pathname;d("unauthenticated",{isAuthenticated:!1,token:null,user:null}),m("login.html",t)});export{c as B,K as a,T as b,_ as c,U as d,nt as e,C as f,L as g,u as h,Y as i,R as j,rt as k,V as l,ot as m,at as n,et as o,X as p,Z as q,W as r,tt as u,Q as v};
