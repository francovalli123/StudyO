import"./modulepreload-polyfill-B5Qt9EMX.js";import{g as _,a as z,i as K,b as O,h as M,c as U,d as G,B as R,f as J}from"./auth-gate-CYQPWai6.js";import{s as V}from"./confirmModal-r5-RcnPR.js";import{b as W,g as Y}from"./responsive-BEQ_P_Nu.js";import{h as Z,s as Q,g as A,a as C,b as X,c as ee,o as te}from"./onboarding-B6DVBAO8.js";document.addEventListener("DOMContentLoaded",async function(){try{const e=await _()}catch(e){console.error("Error al cargar información del usuario:",e),(e.message==="No autenticado"||e.message==="Sesión expirada")&&(window.location.href="login.html")}const t=document.getElementById("logoutBtn");t&&t.addEventListener("click",async e=>{e.preventDefault();try{await z(),window.location.href="index.html"}catch(n){console.error("Error al cerrar sesión:",n),window.location.href="index.html"}})});K({loginPath:"login.html"});const ne=[{icon:"zap",color:"orange",name:"Rayo"},{icon:"book-open",color:"green",name:"Libro"},{icon:"target",color:"red",name:"Objetivo"},{icon:"coffee",color:"blue",name:"Café"},{icon:"brain",color:"purple",name:"Cerebro"},{icon:"clock",color:"yellow",name:"Reloj"},{icon:"flame",color:"orange",name:"Llama"},{icon:"trophy",color:"gold",name:"Trofeo"}],L={orange:{card:"bg-orange-950/40 border-orange-500/30 hover:bg-orange-900/40",text:"text-orange-400",icon:"text-orange-500",check:"bg-orange-500 border-orange-500 text-black"},green:{card:"bg-green-950/40 border-green-500/30 hover:bg-green-900/40",text:"text-green-400",icon:"text-green-500",check:"bg-green-500 border-green-500 text-black"},red:{card:"bg-red-950/40 border-red-500/30 hover:bg-red-900/40",text:"text-red-400",icon:"text-red-500",check:"bg-red-500 border-red-500 text-white"},blue:{card:"bg-blue-950/40 border-blue-500/30 hover:bg-blue-900/40",text:"text-blue-400",icon:"text-blue-500",check:"bg-blue-500 border-blue-500 text-white"},purple:{card:"bg-purple-950/40 border-purple-500/30 hover:bg-purple-900/40",text:"text-purple-400",icon:"text-purple-500",check:"bg-purple-500 border-purple-500 text-white"},yellow:{card:"bg-yellow-950/40 border-yellow-500/30 hover:bg-yellow-900/40",text:"text-yellow-400",icon:"text-yellow-500",check:"bg-yellow-500 border-yellow-500 text-black"},gold:{card:"bg-amber-950/40 border-amber-500/30 hover:bg-amber-900/40",text:"text-amber-400",icon:"text-amber-500",check:"bg-amber-500 border-amber-500 text-black"}};function D(){return Y()}function l(){const t=D();return W[t]}function q(t){const e=new Date().toLocaleString("en-US",{timeZone:t}),n=new Date(e),o=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),a=String(n.getDate()).padStart(2,"0"),i=`${o}-${r}-${a}`;return{now:n,todayKey:i}}function oe(t){const{todayKey:e}=q(t),n=`habit_completions_${e}`;for(let r=0;r<localStorage.length;r++){const a=localStorage.key(r);a&&a.startsWith("habit_completions_")&&a!==n&&localStorage.removeItem(a)}const o=localStorage.getItem(n);return o?new Set(JSON.parse(o)):new Set}function F(t,e){const{todayKey:n}=q(e),o=`habit_completions_${n}`;localStorage.setItem(o,JSON.stringify([...t]))}let c=[],$=[],b=null,m="zap",g="orange",y="UTC",u=new Set;function f(t,e){const n=e>0?Math.round(t/e*100):0,o=l(),r=document.getElementById("progressText");if(r){const i=o.habits.progressText||"Completaste {percent}% de tus hábitos hoy.",s=`<span id="progressPercentage" class="text-purple-400 font-bold">${n}%</span>`;r.innerHTML=i.replace("{percent}",s)}const a=document.getElementById("dailyProgressBar");a&&(a.style.width=`${n}%`,a.setAttribute("data-progress",`${n}`))}async function x(){try{if(!M()){window.location.href="login.html";return}y=(await _()).timezone??"UTC",u=oe(y),c=(await O("/habits/")).map(o=>{const r=o.completed_today||!1;r?u.add(o.id):u.delete(o.id);const a=ae(o);return{...o,completedToday:r,icon:a.icon,color:a.color}}),F(u,y),h(),f(c.filter(o=>o.completedToday).length,c.length),T()}catch(t){console.error("Error loading habits:",t)}}async function re(){try{const t=l();$=await O("/subjects/");const e=document.getElementById("habitSubject");e&&(e.innerHTML=`<option value="">${t.subjects.notSpecified}</option>`+$.map(n=>`<option value="${n.id}">${n.name}</option>`).join(""))}catch(t){console.error(t)}}function ae(t){const e=localStorage.getItem(`habit_${t.id}_icon`);if(e)return JSON.parse(e);const n=t.name.toLowerCase();return n.includes("estudiar")||n.includes("pomodoro")?{icon:"zap",color:"orange"}:n.includes("leer")||n.includes("repasar")?{icon:"book-open",color:"green"}:{icon:"zap",color:"orange"}}function H(t,e,n){localStorage.setItem(`habit_${t}_icon`,JSON.stringify({icon:e,color:n}))}function h(){const t=document.getElementById("habitsGrid"),e=document.getElementById("emptyState");if(!t||!e)return;const n=l();if(D(),c.length===0){t.innerHTML="",t.classList.add("hidden"),e.classList.remove("hidden"),e.classList.add("flex");const r=e.querySelector("h3"),a=e.querySelector("p"),i=document.getElementById("emptyStateAddBtn");if(r&&(r.textContent=n.habits.emptyTitle),a&&(a.textContent=n.habits.emptyDesc),i){const s=i.querySelector("span");s&&(s.textContent=n.habits.createFirst)}f(0,0);return}e.classList.add("hidden"),e.classList.remove("flex"),t.classList.remove("hidden");const o=n.habits.streak;t.innerHTML=c.map(r=>{const a=L[r.color]||L.orange,i=r.completedToday;return`
        <div class="relative group rounded-2xl p-6 border transition-all duration-300 ${a.card}">
            <div class="flex items-start gap-4">
                <div class="flex-1 min-w-0 pr-10">
                    <div class="flex items-center gap-3 mb-2">
                        <i data-lucide="${r.icon}" class="w-6 h-6 ${i?"text-gray-600":a.icon}"></i>
                        <h3 class="font-bold text-lg truncate ${i?"line-through text-gray-500":"text-white"}">
                            ${r.name}
                        </h3>
                    </div>
                    <div class="flex items-center gap-2 text-sm font-medium ${i?"text-gray-600":a.text}">
                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                        <span>${o}: ${r.streak}</span>
                    </div>
                </div>
            </div>

            <button 
                class="habit-complete-btn absolute top-3 right-3 w-8 h-8 rounded-full flex items-center justify-center border-2 transition-all"
                data-habit-id="${r.id}" 
                data-completed="${i}">
                ${i?'<i data-lucide="check" class="w-4 h-4"></i>':""}
            </button>

            <div class="flex gap-3 pt-4 border-t border-gray-700/50">
                <button title="${n.habits.editHabit}" class="edit-habit-btn flex-1 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-gray-700 text-gray-300 hover:text-white text-sm font-medium transition-all duration-300 flex items-center justify-center gap-2" data-habit-id="${r.id}">
                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                </button>
                <button title="${n.common.delete}" class="delete-habit-btn flex-1 px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 hover:text-red-300 text-sm font-medium transition-all duration-300 flex items-center justify-center gap-2" data-habit-id="${r.id}">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </div>`}).join(""),typeof lucide<"u"&&lucide.createIcons(),se()}function ie(t){const e=l(),n=c.find(p=>p.id===t);if(!n)return;b=t,m=n.icon,g=n.color;const o=document.getElementById("habitName"),r=document.getElementById("habitFrequency"),a=document.getElementById("habitSubject"),i=document.getElementById("habitIsKey");o&&(o.value=n.name),r&&(r.value=String(n.frequency)),a&&(a.value=n.subject?String(n.subject):""),i&&(i.checked=!!n.is_key);const s=document.getElementById("modalTitle"),d=document.getElementById("submitBtnText");s&&(s.textContent=e.habits.editHabit),d&&(d.textContent=e.common.save),B(),v()}async function ce(t){const e=l();if(await V(e.confirmations.deleteHabitMessage,e.confirmations.deleteHabitTitle))try{await J(`/habits/${t}/`),localStorage.removeItem(`habit_${t}_icon`),x()}catch(o){console.error("Error deleting habit:",o)}}async function j(t){t.preventDefault();const e=l(),n=document.querySelector('#habitForm button[type="submit"]'),o=document.getElementById("submitBtnText"),r=o?o.innerText:"Guardar";o&&(o.innerText=e.common.loading),n.disabled=!0;try{const a=t.target,i=new FormData(a),s=i.get("name"),d=parseInt(i.get("frequency")),p=i.get("subject"),N=p?parseInt(p):null,P=i.get("is_key")==="on"||i.get("is_key")==="true",I={name:s,frequency:d,subject:N,is_key:P};if(b)await U(`/habits/${b}/`,I),H(b,m,g);else{const E=await G("/habits/",I,!0);H(E.id,m,g)}k();const w=A();if(w&&w.active&&w.step==="CREATE_HABIT"){await x();try{await te()}catch(E){console.warn("onboarding transition failed",E)}return}x()}catch(a){console.error("Error saving habit:",a)}finally{o&&(o.innerText=r),n.disabled=!1}}function se(){document.querySelectorAll(".habit-complete-btn").forEach(t=>{t.addEventListener("click",async e=>{const n=e.currentTarget,o=Number(n.dataset.habitId),r=n.dataset.completed==="true";await le(o,!r)})}),document.querySelectorAll(".edit-habit-btn").forEach(t=>{t.addEventListener("click",e=>{const n=e.currentTarget,o=Number(n.dataset.habitId);ie(o)})}),document.querySelectorAll(".delete-habit-btn").forEach(t=>{t.addEventListener("click",e=>{const n=e.currentTarget,o=Number(n.dataset.habitId);ce(o)})})}async function le(t,e){const n=M();if(!n)return;const o=c.findIndex(i=>i.id===t);if(o===-1)return;const r=c[o].completedToday,a=c[o].streak;try{c[o].completedToday=e,e?u.add(t):u.delete(t),F(u,y),f(c.filter(d=>d.completedToday).length,c.length),h();const i=await fetch(`${R}/habits/${t}/complete/`,{method:e?"POST":"DELETE",headers:{"Content-Type":"application/json",Authorization:`Token ${n}`}});if(!i.ok)throw new Error("Error API");const s=await i.json();if(s.streak!==void 0){c[o].streak=s.streak,h();try{document.dispatchEvent(new CustomEvent("weeklyChallenge:update"))}catch{}}}catch{c[o].completedToday=r,c[o].streak=a,h(),f(c.filter(s=>s.completedToday).length,c.length),T()}}function T(){const t=A();if(!t||!t.active||t.step!=="CREATE_HABIT"){C();return}const e=document.getElementById("habitIsKey"),n=document.getElementById("onboardingHabitKeyHint");e&&e.classList.add("onboarding-highlight"),n&&n.classList.remove("hidden");const o=l();X({title:o.onboarding?.stepCreateHabitTitle||"Paso 2: Creá un hábito",body:o.onboarding?.stepCreateHabitBody||"Creá un hábito y revisá “Hábito clave”.",primaryText:o.onboarding?.createHabit||"Crear hábito",lockClose:!0,allowSkip:!0,onSkip:async()=>{try{await ee()}catch{}C()},onPrimary:()=>{S(),v()}})}window.addEventListener("DOMContentLoaded",async()=>{await Z(),Q(()=>T()),re(),x(),de()});function de(){const t=document.getElementById("addHabitBtn"),e=document.getElementById("emptyStateAddBtn"),n=document.getElementById("cancelBtn"),o=document.getElementById("closeModalBtn"),r=document.getElementById("habitForm");t&&t.addEventListener("click",()=>{S(),v()}),e&&e.addEventListener("click",()=>{S(),v()}),n&&n.addEventListener("click",k),o&&o.addEventListener("click",k),r&&(r.removeEventListener("submit",j),r.addEventListener("submit",j))}function S(){const t=l();b=null,m="zap",g="orange";const e=document.getElementById("habitForm");e&&e.reset();const n=document.getElementById("modalTitle"),o=document.getElementById("submitBtnText");n&&(n.textContent=t.habits.addHabit),o&&(o.textContent=t.habits.createHabit),B()}function v(){const t=document.getElementById("habitModal");if(t){t.classList.add("active");const e=t.querySelector(".modal-content");e&&(e.classList.remove("animate-fade-out"),e.classList.add("animate-fade-in"))}}function k(){const t=document.getElementById("habitModal");t&&t.classList.remove("active")}function B(){const t=document.querySelector("#habitForm .grid");t&&(t.innerHTML=ne.map(e=>`
        <div class="icon-option cursor-pointer p-3 rounded-xl border border-gray-700 bg-dark-input hover:border-${e.color}-500 flex items-center justify-center transition-all ${m===e.icon?`border-${e.color}-500 bg-${e.color}-500/10 ring-2 ring-${e.color}-500/50`:""}"
             onclick="selectIcon('${e.icon}', '${e.color}')">
            <i data-lucide="${e.icon}" class="w-6 h-6 text-${e.color}-500"></i>
        </div>
    `).join(""),typeof lucide<"u"&&lucide.createIcons(),window.selectIcon=(e,n)=>{m=e,g=n,B()})}
