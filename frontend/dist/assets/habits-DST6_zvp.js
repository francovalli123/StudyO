import"./modulepreload-polyfill-B5Qt9EMX.js";import{g as _,a as z,i as K,b as O,h as M,c as U,d as G,B as R,f as J}from"./auth-gate-BVWKmKT_.js";import{s as V}from"./confirmModal-r5-RcnPR.js";import{b as W,g as Y}from"./responsive-BEQ_P_Nu.js";import{h as Z,s as Q,g as A,a as C,b as X,c as ee,o as te}from"./onboarding-DyRprQDl.js";document.addEventListener("DOMContentLoaded",async function(){try{const e=await _()}catch(e){console.error("Error al cargar información del usuario:",e),(e.message==="No autenticado"||e.message==="Sesión expirada")&&(window.location.href="/login")}const t=document.getElementById("logoutBtn");t&&t.addEventListener("click",async e=>{e.preventDefault();try{await z(),window.location.href="/"}catch(o){console.error("Error al cerrar sesión:",o),window.location.href="/"}})});K({loginPath:"/login"});const oe=[{icon:"zap",color:"orange",name:"Rayo"},{icon:"book-open",color:"green",name:"Libro"},{icon:"target",color:"red",name:"Objetivo"},{icon:"coffee",color:"blue",name:"Café"},{icon:"brain",color:"purple",name:"Cerebro"},{icon:"clock",color:"yellow",name:"Reloj"},{icon:"flame",color:"orange",name:"Llama"},{icon:"trophy",color:"gold",name:"Trofeo"}],L={orange:{card:"bg-orange-950/40 border-orange-500/30 hover:bg-orange-900/40",text:"text-orange-400",icon:"text-orange-500",check:"bg-orange-500 border-orange-500 text-black"},green:{card:"bg-green-950/40 border-green-500/30 hover:bg-green-900/40",text:"text-green-400",icon:"text-green-500",check:"bg-green-500 border-green-500 text-black"},red:{card:"bg-red-950/40 border-red-500/30 hover:bg-red-900/40",text:"text-red-400",icon:"text-red-500",check:"bg-red-500 border-red-500 text-white"},blue:{card:"bg-blue-950/40 border-blue-500/30 hover:bg-blue-900/40",text:"text-blue-400",icon:"text-blue-500",check:"bg-blue-500 border-blue-500 text-white"},purple:{card:"bg-purple-950/40 border-purple-500/30 hover:bg-purple-900/40",text:"text-purple-400",icon:"text-purple-500",check:"bg-purple-500 border-purple-500 text-white"},yellow:{card:"bg-yellow-950/40 border-yellow-500/30 hover:bg-yellow-900/40",text:"text-yellow-400",icon:"text-yellow-500",check:"bg-yellow-500 border-yellow-500 text-black"},gold:{card:"bg-amber-950/40 border-amber-500/30 hover:bg-amber-900/40",text:"text-amber-400",icon:"text-amber-500",check:"bg-amber-500 border-amber-500 text-black"}};function D(){return Y()}function d(){const t=D();return W[t]}function q(t){const e=new Date().toLocaleString("en-US",{timeZone:t}),o=new Date(e),n=o.getFullYear(),r=String(o.getMonth()+1).padStart(2,"0"),a=String(o.getDate()).padStart(2,"0"),i=`${n}-${r}-${a}`;return{now:o,todayKey:i}}function ne(t){const{todayKey:e}=q(t),o=`habit_completions_${e}`;for(let r=0;r<localStorage.length;r++){const a=localStorage.key(r);a&&a.startsWith("habit_completions_")&&a!==o&&localStorage.removeItem(a)}const n=localStorage.getItem(o);return n?new Set(JSON.parse(n)):new Set}function F(t,e){const{todayKey:o}=q(e),n=`habit_completions_${o}`;localStorage.setItem(n,JSON.stringify([...t]))}let c=[],$=[],m=null,b="zap",g="orange",y="UTC",u=new Set;function h(t,e){const o=e>0?Math.round(t/e*100):0,n=d(),r=document.getElementById("progressText");if(r){const i=n.habits.progressText||"Completaste {percent}% de tus hábitos hoy.",s=`<span id="progressPercentage" class="text-purple-400 font-bold">${o}%</span>`;r.innerHTML=i.replace("{percent}",s)}const a=document.getElementById("dailyProgressBar");a&&(a.style.width=`${o}%`,a.setAttribute("data-progress",`${o}`))}async function x(){try{if(!M()){window.location.href="/login";return}y=(await _()).timezone??"UTC",u=ne(y),c=(await O("/habits/")).map(n=>{const r=n.completed_today||!1;r?u.add(n.id):u.delete(n.id);const a=ae(n);return{...n,completedToday:r,icon:a.icon,color:a.color}}),F(u,y),f(),h(c.filter(n=>n.completedToday).length,c.length),T()}catch(t){console.error("Error loading habits:",t)}}async function re(){try{const t=d();$=await O("/subjects/");const e=document.getElementById("habitSubject");e&&(e.innerHTML=`<option value="">${t.subjects.notSpecified}</option>`+$.map(o=>`<option value="${o.id}">${o.name}</option>`).join(""))}catch(t){console.error(t)}}function ae(t){const e=localStorage.getItem(`habit_${t.id}_icon`);if(e)return JSON.parse(e);const o=t.name.toLowerCase();return o.includes("estudiar")||o.includes("pomodoro")?{icon:"zap",color:"orange"}:o.includes("leer")||o.includes("repasar")?{icon:"book-open",color:"green"}:{icon:"zap",color:"orange"}}function H(t,e,o){localStorage.setItem(`habit_${t}_icon`,JSON.stringify({icon:e,color:o}))}function f(){const t=document.getElementById("habitsGrid"),e=document.getElementById("emptyState");if(!t||!e)return;const o=d();if(D(),c.length===0){t.innerHTML="",t.classList.add("hidden"),e.classList.remove("hidden"),e.classList.add("flex");const r=e.querySelector("h3"),a=e.querySelector("p"),i=document.getElementById("emptyStateAddBtn");if(r&&(r.textContent=o.habits.emptyTitle),a&&(a.textContent=o.habits.emptyDesc),i){const s=i.querySelector("span");s&&(s.textContent=o.habits.createFirst)}h(0,0);return}e.classList.add("hidden"),e.classList.remove("flex"),t.classList.remove("hidden");const n=o.habits.streak;t.innerHTML=c.map(r=>{const a=L[r.color]||L.orange,i=r.completedToday;return`
        <div class="relative group rounded-2xl p-6 border transition-all duration-300 ${a.card}">
            <div class="flex items-start gap-4">
                <div class="flex-1 min-w-0 pr-10">
                    <div class="flex items-center gap-3 mb-2">
                        <i data-lucide="${r.icon}" class="w-6 h-6 ${i?"text-gray-600":a.icon}"></i>
                        <h3 class="font-bold text-lg truncate ${i?"line-through text-gray-500":"text-white"}">
                            ${r.name}
                        </h3>
                    </div>
                    <div class="flex items-center gap-2 text-sm font-medium ${i?"text-gray-600":a.text}">
                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                        <span>${n}: ${r.streak}</span>
                    </div>
                </div>
            </div>

            <button 
                class="habit-complete-btn absolute top-3 right-3 w-8 h-8 rounded-full flex items-center justify-center border-2 transition-all"
                data-habit-id="${r.id}" 
                data-completed="${i}">
                ${i?'<i data-lucide="check" class="w-4 h-4"></i>':""}
            </button>

            <div class="flex gap-3 pt-4 border-t border-gray-700/50">
                <button title="${o.habits.editHabit}" class="edit-habit-btn flex-1 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-gray-700 text-gray-300 hover:text-white text-sm font-medium transition-all duration-300 flex items-center justify-center gap-2" data-habit-id="${r.id}">
                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                </button>
                <button title="${o.common.delete}" class="delete-habit-btn flex-1 px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 hover:text-red-300 text-sm font-medium transition-all duration-300 flex items-center justify-center gap-2" data-habit-id="${r.id}">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </div>`}).join(""),typeof lucide<"u"&&lucide.createIcons(),se()}function ie(t){const e=d(),o=c.find(p=>p.id===t);if(!o)return;m=t,b=o.icon,g=o.color;const n=document.getElementById("habitName"),r=document.getElementById("habitFrequency"),a=document.getElementById("habitSubject"),i=document.getElementById("habitIsKey");n&&(n.value=o.name),r&&(r.value=String(o.frequency)),a&&(a.value=o.subject?String(o.subject):""),i&&(i.checked=!!o.is_key);const s=document.getElementById("modalTitle"),l=document.getElementById("submitBtnText");s&&(s.textContent=e.habits.editHabit),l&&(l.textContent=e.common.save),B(),v()}async function ce(t){const e=d();if(await V(e.confirmations.deleteHabitMessage,e.confirmations.deleteHabitTitle))try{await J(`/habits/${t}/`),localStorage.removeItem(`habit_${t}_icon`),x()}catch(n){console.error("Error deleting habit:",n)}}async function j(t){t.preventDefault();const e=d(),o=document.querySelector('#habitForm button[type="submit"]'),n=document.getElementById("submitBtnText"),r=n?n.innerText:"Guardar";n&&(n.innerText=e.common.loading),o.disabled=!0;try{const a=t.target,i=new FormData(a),s=i.get("name"),l=parseInt(i.get("frequency")),p=i.get("subject"),N=p?parseInt(p):null,P=i.get("is_key")==="on"||i.get("is_key")==="true",I={name:s,frequency:l,subject:N,is_key:P};if(m)await U(`/habits/${m}/`,I),H(m,b,g);else{const E=await G("/habits/",I,!0);H(E.id,b,g)}k();const w=A();if(w&&w.active&&w.step==="CREATE_HABIT"){await x();try{await te()}catch(E){console.warn("onboarding transition failed",E)}return}x()}catch(a){console.error("Error saving habit:",a)}finally{n&&(n.innerText=r),o.disabled=!1}}function se(){document.querySelectorAll(".habit-complete-btn").forEach(t=>{t.addEventListener("click",async e=>{const o=e.currentTarget,n=Number(o.dataset.habitId),r=o.dataset.completed==="true";await de(n,!r)})}),document.querySelectorAll(".edit-habit-btn").forEach(t=>{t.addEventListener("click",e=>{const o=e.currentTarget,n=Number(o.dataset.habitId);ie(n)})}),document.querySelectorAll(".delete-habit-btn").forEach(t=>{t.addEventListener("click",e=>{const o=e.currentTarget,n=Number(o.dataset.habitId);ce(n)})})}async function de(t,e){const o=M();if(!o)return;const n=c.findIndex(i=>i.id===t);if(n===-1)return;const r=c[n].completedToday,a=c[n].streak;try{c[n].completedToday=e,e?u.add(t):u.delete(t),F(u,y),h(c.filter(l=>l.completedToday).length,c.length),f();const i=await fetch(`${R}/habits/${t}/complete/`,{method:e?"POST":"DELETE",headers:{"Content-Type":"application/json",Authorization:`Token ${o}`}});if(!i.ok)throw new Error("Error API");const s=await i.json();if(s.streak!==void 0){c[n].streak=s.streak,f();try{document.dispatchEvent(new CustomEvent("weeklyChallenge:update"))}catch{}}}catch{c[n].completedToday=r,c[n].streak=a,f(),h(c.filter(s=>s.completedToday).length,c.length),T()}}function T(){const t=A();if(!t||!t.active||t.step!=="CREATE_HABIT"){C();return}const e=document.getElementById("habitIsKey"),o=document.getElementById("onboardingHabitKeyHint");e&&e.classList.add("onboarding-highlight"),o&&o.classList.remove("hidden");const n=d();X({title:n.onboarding?.stepCreateHabitTitle||"Paso 2: Creá un hábito",body:n.onboarding?.stepCreateHabitBody||"Creá un hábito y revisá “Hábito clave”.",primaryText:n.onboarding?.createHabit||"Crear hábito",lockClose:!0,allowSkip:!0,onSkip:async()=>{try{await ee()}catch{}C()},onPrimary:()=>{S(),v()}})}window.addEventListener("DOMContentLoaded",async()=>{await Z(),Q(()=>T()),re(),x(),le()});function le(){const t=document.getElementById("addHabitBtn"),e=document.getElementById("emptyStateAddBtn"),o=document.getElementById("cancelBtn"),n=document.getElementById("closeModalBtn"),r=document.getElementById("habitForm");t&&t.addEventListener("click",()=>{S(),v()}),e&&e.addEventListener("click",()=>{S(),v()}),o&&o.addEventListener("click",k),n&&n.addEventListener("click",k),r&&(r.removeEventListener("submit",j),r.addEventListener("submit",j))}function S(){const t=d();m=null,b="zap",g="orange";const e=document.getElementById("habitForm");e&&e.reset();const o=document.getElementById("modalTitle"),n=document.getElementById("submitBtnText");o&&(o.textContent=t.habits.addHabit),n&&(n.textContent=t.habits.createHabit),B()}function v(){const t=document.getElementById("habitModal");if(t){t.classList.add("active");const e=t.querySelector(".modal-content");e&&(e.classList.remove("animate-fade-out"),e.classList.add("animate-fade-in"))}}function k(){const t=document.getElementById("habitModal");t&&t.classList.remove("active")}function B(){const t=document.querySelector("#habitForm .grid");t&&(t.innerHTML=oe.map(e=>`
        <div class="icon-option cursor-pointer p-3 rounded-xl border border-gray-700 bg-dark-input hover:border-${e.color}-500 flex items-center justify-center transition-all ${b===e.icon?`border-${e.color}-500 bg-${e.color}-500/10 ring-2 ring-${e.color}-500/50`:""}"
             onclick="selectIcon('${e.icon}', '${e.color}')">
            <i data-lucide="${e.icon}" class="w-6 h-6 text-${e.color}-500"></i>
        </div>
    `).join(""),typeof lucide<"u"&&lucide.createIcons(),window.selectIcon=(e,o)=>{b=e,g=o,B()})}
