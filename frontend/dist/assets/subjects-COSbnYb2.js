import"./modulepreload-polyfill-B5Qt9EMX.js";import{g as w,a as E,i as _,b as B,h as k,c as L,d as I,f as T}from"./auth-gate-B8HnkSQA.js";import{i as C,s as M}from"./confirmModal-L4nKbxRN.js";import{h as $,s as O,g as q,a as S,b as A,c as D,e as N}from"./onboarding-B5C-bpxo.js";import{b,g}from"./responsive-DwadFwRg.js";document.addEventListener("DOMContentLoaded",async function(){try{const e=await w()}catch(e){console.error("Error al cargar información del usuario:",e),(e.message==="No autenticado"||e.message==="Sesión expirada")&&(window.location.href="/login")}const a=document.getElementById("logoutBtn");a&&a.addEventListener("click",async e=>{e.preventDefault();try{await E(),window.location.href="/"}catch(r){console.error("Error al cerrar sesión:",r),window.location.href="/"}})});_({loginPath:"/login"});let m=[],p=null;async function y(){try{const a=b[g()],e=a.subjects,r=a.common;m=await B("/subjects/"),console.debug("Loaded subjects:",m,"authToken:",k());const o=document.getElementById("subjects-container"),n=document.getElementById("emptyState");if(!o||!n)return;if(m.length===0){o.innerHTML="",o.classList.add("hidden"),n.classList.remove("hidden");const t=n.querySelector("h3"),i=n.querySelector("p"),s=document.getElementById("emptyStateSubjectBtn");if(t&&(t.textContent=e.emptyTitle),i&&(i.textContent=e.emptyDesc),s){const c=s.querySelector("span");c&&(c.textContent=e.createFirst)}j();return}n.classList.add("hidden"),o.classList.remove("hidden"),o.innerHTML=m.map(t=>`
                <div class="bg-dark-card rounded-2xl p-6 relative group" style="box-shadow: 0 0 0 1px rgba(168,85,247,0.2), 0 0 30px rgba(168,85,247,0.15), inset 0 0 20px rgba(168,85,247,0.03);">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500/30 via-fuchsia-500/30 to-purple-500/30 flex items-center justify-center flex-shrink-0" style="box-shadow: 0 0 0 1px rgba(168,85,247,0.3);">
                                <i data-lucide="book-open" class="w-5 h-5 text-purple-400"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-white">${t.name}</h3>
                                <p class="text-sm text-gray-400 mt-1">${e.professorShort} ${t.professor_name||e.notSpecified}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-400">${e.progressLabel}</span>
                            <span class="text-sm font-bold text-purple-400">${t.progress||0}%</span>
                        </div>
                        <div class="text-xs text-gray-400 mb-2">${(e.weeklyMinutesLabel||"").replace("{done}",String(t.study_minutes_week||0)).replace("{target}",String(t.weekly_target_minutes||0))} </div>
                        <div class="w-full h-2 rounded-full bg-gray-700/50" style="box-shadow: inset 0 0 10px rgba(0,0,0,0.3);">
                            <div class="h-full rounded-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300" style="width: ${t.progress||0}%; box-shadow: 0 0 15px rgba(168,85,247,0.6);"></div>
                        </div>
                    </div>

                    ${t.next_exam_date?`<div class="mb-4 text-xs text-gray-400"><i data-lucide="calendar" class="w-3 h-3 inline mr-1"></i> ${e.nextExam}: ${t.next_exam_date}</div>`:""}

                    <div class="flex gap-3 pt-4 border-t border-gray-700/50">
                        <button class="edit-subject-btn flex-1 px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-gray-700 text-gray-300 hover:text-white text-sm font-medium transition-all duration-300 flex items-center justify-center gap-2" data-subject-id="${t.id}">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                            <span>${e.editAction||r.edit}</span>
                        </button>
                        <button class="delete-subject-btn flex-1 px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 hover:text-red-300 text-sm font-medium transition-all duration-300 flex items-center justify-center gap-2" data-subject-id="${t.id}">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            <span>${e.deleteAction||r.delete}</span>
                        </button>
                    </div>
                </div>
            `).join(""),typeof lucide<"u"&&lucide.createIcons(),P(),j()}catch(a){console.error("Error loading subjects:",a);const e=document.getElementById("subjects-container");e&&(e.innerHTML='<p class="text-red-400 col-span-full">Error loading subjects</p>')}}function P(){const a=document.getElementById("subjects-container");a&&a.addEventListener("click",async e=>{const r=e.target,o=r.closest(".edit-subject-btn");if(o){const t=o.dataset.subjectId;t&&x(parseInt(t));return}const n=r.closest(".delete-subject-btn");if(n){const t=n.dataset.subjectId;t&&await F(parseInt(t));return}})}async function F(a){const e=b[g()];if(await M(e.confirmations.deleteSubjectMessage,e.confirmations.deleteSubjectTitle))try{await T(`/subjects/${a}/`),y()}catch(o){console.error("Error deleting subject:",o);try{const n=o;let t=null;if(typeof n=="string")t=JSON.parse(n);else if(n&&typeof n.message=="string")try{t=JSON.parse(n.message)}catch{t=n}else t=n;t&&t.detail&&String(t.detail).includes("No Subject matches")?alert("Subject not found or you don't have permission to delete it."):alert("Error deleting subject.")}catch{alert("Error deleting subject")}}}async function G(a){a.preventDefault();const e=b[g()],r=e.common;e.subjects;const o=a.target,n=o.querySelector('button[type="submit"]'),t=n.innerText,i=p!==null;n.innerText=r.loading,n.disabled=!0;try{const s=new FormData(o),c={name:s.get("name"),professor_name:s.get("professor_name")||void 0,color:s.get("color")||void 0,next_exam_date:s.get("next_exam_date")||void 0,weekly_target_minutes:(()=>{const l=s.get("weekly_target_minutes");if(!l)return;const u=Number(l);return isNaN(u)?void 0:Math.max(0,Math.floor(u))})()},d=s.get("priority");if(c.priority=d?parseInt(d):void 0,i?(await L(`/subjects/${p}/`,c),console.log("Subject updated successfully!")):(await I("/subjects/",c,!0),console.log("Subject created successfully!")),f(),!i){await y();try{await N()}catch(l){console.warn("onboarding transition failed",l)}return}y()}catch(s){console.error(`Error ${i?"updating":"saving"} subject:`,s),alert(`Error ${i?"updating":"creating"} subject. Check console.`)}finally{n.innerText=t,n.disabled=!1,p=null}}function x(a=null){const e=document.getElementById("subjectModal"),r=document.getElementById("subjectForm"),n=b[g()].subjects;if(!e||!r)return;p=a,r.reset();const t=e.querySelector("h2"),i=r.querySelector('button[type="submit"]');if(a!==null){const s=m.find(c=>c.id===a);if(s){const c=r.querySelector('[name="name"]'),d=r.querySelector('[name="professor_name"]'),l=r.querySelector('[name="priority"]'),u=r.querySelector('[name="color"]'),v=r.querySelector('[name="next_exam_date"]');c&&(c.value=s.name),d&&(d.value=s.professor_name||""),l&&(l.value=s.priority?String(s.priority):""),u&&(u.value=s.color||"");const h=r.querySelector('[name="weekly_target_minutes"]');h&&(h.value=s.weekly_target_minutes?String(s.weekly_target_minutes):""),s.next_exam_date&&v&&(v.value=s.next_exam_date),t&&(t.innerText=n.editSubject),i&&(i.innerText=n.updateSubject)}}else t&&(t.innerText=n.newSubject),i&&(i.innerText=n.createSubject);e.classList.add("active")}function f(){const a=document.getElementById("subjectModal");a&&a.classList.remove("active")}function H(){const a=document.getElementById("addSubjectBtn"),e=document.getElementById("closeSubjectModalBtn"),r=document.getElementById("cancelSubjectBtn"),o=document.getElementById("subjectForm"),n=document.getElementById("emptyStateSubjectBtn"),t=document.getElementById("subjectModal");a&&a.addEventListener("click",()=>x(null)),n&&n.addEventListener("click",()=>x(null)),e&&e.addEventListener("click",f),r&&r.addEventListener("click",f),o&&o.addEventListener("submit",G),t&&t.addEventListener("click",i=>{i.target===t&&f()})}function j(){const a=q();if(!a||!a.active||a.step!=="CREATE_SUBJECT"){S();return}const e=b[g()];A({title:e.onboarding?.stepCreateSubjectTitle||"Paso 1: Creá tu primera asignatura",body:e.onboarding?.stepCreateSubjectBody||"Creá 1 asignatura para activar el tracking real de tu estudio.",primaryText:e.onboarding?.createSubject||"Crear asignatura",lockClose:!0,allowSkip:!0,onSkip:async()=>{try{await D()}catch{}S()},onPrimary:()=>x(null)})}window.addEventListener("DOMContentLoaded",async()=>{C(),H(),await $(),O(()=>j()),y()});
